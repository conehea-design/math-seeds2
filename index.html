<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìˆ˜í•™ ì´ì•¼ê¸° ì”¨ì•—</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --main-green: #3a5a40;
            --light-green: #e8f5e9;
            --point-green: #588157;
            --button-green: #a3b18a;
            --button-border: #707c5d;
            --background-blue: #f0f8ff;
            --text-dark: #333;
            --text-light: #555;
            --input-background: #fafafa;
            --danger-red: #c94a4a;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: var(--background-blue);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .app-container {
            width: 90%;
            max-width: 600px;
        }

        #start-screen {
            background-color: #ffffff;
            border-radius: 20px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            padding: 40px;
            text-align: center;
        }

        #start-screen h1 {
            color: var(--main-green);
            font-size: 2.2em;
            margin-bottom: 10px;
        }
        
        #start-screen p {
            color: var(--text-light);
            font-size: 1.2em;
            margin-top: 0;
            margin-bottom: 30px;
        }

        .chapter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
        }

        .chapter-btn {
            background-color: var(--light-green);
            border: 2px solid var(--point-green);
            border-radius: 15px;
            padding: 20px;
            font-family: 'Noto Sans KR', sans-serif;
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            color: var(--main-green);
        }

        .chapter-btn:hover {
            background-color: var(--point-green);
            color: white;
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        #game-screen { display: none; }
        .container {
            background-color: #ffffff;
            border-radius: 20px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            padding: 30px;
            text-align: center;
        }
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        h1.game-title {
            color: var(--main-green);
            font-size: 1.8em;
            margin: 0;
            text-align: left;
        }
        #attempts-tracker {
            font-size: 1.2em;
            font-weight: 700;
            color: var(--danger-red);
        }

        .story-container {
            background-color: var(--light-green);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            font-size: 1.2em;
            color: #2e7d32;
            line-height: 1.6;
            text-align: left;
        }
        .question-container {
            font-size: 1.3em;
            color: var(--text-dark);
            margin-bottom: 20px;
            font-weight: 700;
        }
        .options-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .option-btn {
            background-color: var(--button-green);
            border: none;
            border-radius: 15px;
            padding: 20px;
            font-family: 'Noto Sans KR', sans-serif;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            color: white;
            border-bottom: 5px solid var(--button-border);
            text-align: left;
        }
        .option-btn:hover { background-color: #93a076; }
        .option-btn:active {
            transform: translateY(2px);
            border-bottom-width: 3px;
        }
        .hint-container {
            display: none;
            margin-top: 20px;
            background-color: #fffde7;
            border: 2px dashed #fbc02d;
            border-radius: 10px;
            padding: 15px;
            font-size: 1.2em;
            color: #f57f17;
        }
        .progress-container {
            margin-top: 30px;
            height: 100px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #progress-image {
            height: 100%;
            transition: transform 0.5s;
        }
        .final-message {
            font-size: 1.8em;
            color: #d81b60;
            font-weight: bold;
            margin-bottom: 20px;
        }
        #back-to-start {
            margin-top: 20px;
            padding: 10px 20px;
            font-size: 1em;
            cursor: pointer;
            border-radius: 10px;
            border: 2px solid var(--main-green);
            background-color: white;
            color: var(--main-green);
            font-weight: 700;
            transition: all 0.3s;
        }
        #back-to-start:hover {
            background-color: var(--main-green);
            color: white;
        }
        
        #text-answer-area { margin-top: 20px; }
        #text-answer-input {
            width: 100%;
            height: 100px;
            padding: 15px;
            font-family: 'Noto Sans KR', sans-serif;
            font-size: 1.1em;
            border: 2px solid #ccc;
            border-radius: 10px;
            resize: vertical;
            box-sizing: border-box;
        }
        .submit-area {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        #submit-text-answer, #mic-btn {
            padding: 12px 25px;
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            border-radius: 10px;
            border: none;
            transition: background-color 0.3s;
        }
        #submit-text-answer {
            background-color: var(--point-green);
            color: white;
        }
        #submit-text-answer:hover { background-color: var(--main-green); }
        #mic-btn {
            background-color: #4a90e2;
            color: white;
        }
        #mic-btn:hover { background-color: #357abd; }
        #mic-btn.listening {
            background-color: #d0021b;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(208, 2, 27, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(208, 2, 27, 0); }
            100% { box-shadow: 0 0 0 0 rgba(208, 2, 27, 0); }
        }

    </style>
</head>
<body>

    <div class="app-container">
        <div id="start-screen">
            <h1>ìˆ˜í•™ ì´ì•¼ê¸° ì”¨ì•— ğŸŒ±</h1>
            <p>ê³µë¶€í•˜ê³  ì‹¶ì€ ë‹¨ì›ì„ ì„ íƒí•´ë´!</p>
            <div class="chapter-grid" id="chapter-selection"></div>
        </div>

        <div id="game-screen">
            <div class="container">
                <div class="game-header">
                    <h1 class="game-title">ìˆ˜í•™ ì´ì•¼ê¸° ì”¨ì•—</h1>
                    <div id="attempts-tracker">ë‚¨ì€ ê¸°íšŒ: 8</div>
                </div>
                <div id="game-area">
                    </div>
                <div class="progress-container">
                    <img id="progress-image" src='data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Cellipse cx="50" cy="75" rx="20" ry="15" fill="%238B4513"/%3E%3C/svg%3E' alt="ì”¨ì•—">
                </div>
            </div>
        </div>
    </div>

    <script>
        const chapterInfo = {
            'chapter1': { name: '1. ìˆ˜ì˜ ã…‚ã…‡ì™€ ì–´ë¦¼í•˜ê¸°', fullName: '1. ìˆ˜ì˜ ë²”ìœ„ì™€ ì–´ë¦¼í•˜ê¸°' },
            'chapter2': { name: '2. ë¶„ìˆ˜ì˜ ã„±ã……', fullName: '2. ë¶„ìˆ˜ì˜ ê³±ì…ˆ' },
            'chapter3': { name: '3. ã…ã„·ê³¼ ëŒ€ì¹­', fullName: '3. í•©ë™ê³¼ ëŒ€ì¹­' },
            'chapter4': { name: '4. ì†Œìˆ˜ì˜ ã„±ã……', fullName: '4. ì†Œìˆ˜ì˜ ê³±ì…ˆ' },
            'chapter5': { name: '5. ã…ˆã…‡ã…ã…Š', fullName: '5. ì§ìœ¡ë©´ì²´' },
            'chapter6': { name: '6. ã…ã„±ê³¼ ê°€ëŠ¥ì„±', fullName: '6. í‰ê· ê³¼ ê°€ëŠ¥ì„±' }
        };

        const allQuizData = {
            'chapter1': {
                'í•˜': [
                    { difficulty: 'í•˜', story: "ë†€ì´ê³µì›ì˜ ì¸ê¸° ìˆëŠ” ë¡¤ëŸ¬ì½”ìŠ¤í„°ëŠ” í‚¤ê°€ 140cm ì´ìƒì¸ ì–´ë¦°ì´ë§Œ íƒˆ ìˆ˜ ìˆì–´. ì•ˆì „ì„ ìœ„í•´ ê¼­ ì§€ì¼œì•¼ í•˜ëŠ” ê·œì¹™ì´ì§€. ì˜¤ëŠ˜ ë†€ì´ê³µì›ì— ì˜¨ ì§€í˜œì˜ í‚¤ë¥¼ ì¬ì–´ë³´ë‹ˆ ì •í™•íˆ 140cmì˜€ì–´. ì§€í˜œëŠ” ê³¼ì—° ë¡¤ëŸ¬ì½”ìŠ¤í„°ë¥¼ íƒˆ ìˆ˜ ìˆì„ê¹Œ?", question: "'140cm ì´ìƒ'ì´ë¼ëŠ” ë§ì€ 140cmë¥¼ í¬í•¨í•˜ëŠ” ê²ƒì¼ê¹Œ?", options: [{ text: "ë„¤, 140cmì™€ ê°™ê±°ë‚˜ í° ìˆ˜ë¥¼ ì˜ë¯¸í•˜ë¯€ë¡œ íƒˆ ìˆ˜ ìˆì–´ìš”.", isCorrect: true }, { text: "ì•„ë‹ˆìš”, 140cmë³´ë‹¤ ì»¤ì•¼ë§Œ í•˜ë¯€ë¡œ íƒˆ ìˆ˜ ì—†ì–´ìš”.", isCorrect: false }], hint: "'ì´ìƒ'ì€ ê¸°ì¤€ ìˆ˜ë¥¼ í¬í•¨í•´ì„œ, ê°™ê±°ë‚˜ í° ìˆ˜ë¥¼ ì˜ë¯¸í•´." },
                    { difficulty: 'í•˜', story: "ë§ˆíŠ¸ì—ì„œ '7ì„¸ ì´í•˜ ì–´ë¦°ì´ì—ê²Œë§Œ ì‚¬íƒ• ì¦ì •' ì´ë²¤íŠ¸ë¥¼ í•˜ê³  ìˆì–´. í–‰ì‚¬ì— ì°¸ì—¬í•œ ë™ìƒì˜ ë‚˜ì´ê°€ 7ì‚´ì´ë¼ë©´, ì‚¬íƒ•ì„ ë°›ì„ ìˆ˜ ìˆì„ê¹Œ?", question: "ì •í™•íˆ 7ì‚´ì¸ ì–´ë¦°ì´ëŠ” ì‚¬íƒ•ì„ ë°›ì„ ìˆ˜ ìˆì„ê¹Œ?", options: [{ text: "ë„¤, 'ì´í•˜'ëŠ” 7ì‚´ê³¼ ê°™ê±°ë‚˜ ì–´ë¦° ë‚˜ì´ë¥¼ ëœ»í•´ìš”.", isCorrect: true }, { text: "ì•„ë‹ˆìš”, 7ì‚´ë³´ë‹¤ ì–´ë ¤ì•¼ë§Œ ë°›ì„ ìˆ˜ ìˆì–´ìš”.", isCorrect: false }], hint: "'ì´í•˜'ëŠ” ê¸°ì¤€ì´ ë˜ëŠ” ìˆ˜ë¥¼ í¬í•¨í•´." }
                ],
                'ì¤‘': [
                    { difficulty: 'ì¤‘', story: "ì˜í™”ê´€ì—ì„œ ìƒˆë¡œ ê°œë´‰í•œ ì˜í™”ê°€ '12ì„¸ ì´ˆê³¼ ê´€ëŒê°€'ë˜.", question: "ì´ ì˜í™”ë¥¼ ë³¼ ìˆ˜ ìˆëŠ” ë‚˜ì´ë¥¼ ë°”ë¥´ê²Œ ì„¤ëª…í•œ ë¬¸ì¥ì„ ê³¨ë¼ë´.", options: [{ text: "12ì‚´ì€ ë³¼ ìˆ˜ ì—†ê³ , 13ì‚´ë¶€í„° ë³¼ ìˆ˜ ìˆë‹¤ëŠ” ëœ»ì´ì•¼.", isCorrect: true }, { text: "12ì‚´ì„ í¬í•¨í•´ì„œ 12ì‚´ë³´ë‹¤ ë‚˜ì´ê°€ ë§ìœ¼ë©´ ë³¼ ìˆ˜ ìˆë‹¤ëŠ” ëœ»ì´ì•¼.", isCorrect: false }], hint: "'ì´ˆê³¼'ëŠ” ê¸°ì¤€ ìˆ˜ë¥¼ í¬í•¨í•˜ì§€ ì•Šê³ , ê·¸ ìˆ˜ë³´ë‹¤ í° ìˆ˜ë¥¼ ì˜ë¯¸í•´." },
                    { difficulty: 'ì¤‘', story: "ì²´ìœ¡ ì‹œê°„ì— 100m ë‹¬ë¦¬ê¸° ê¸°ë¡ì´ '15ì´ˆ ë¯¸ë§Œ'ì¸ ì¹œêµ¬ë“¤ë§Œ ëŒ€í‘œ ì„ ìˆ˜ë¡œ ë½‘ê¸°ë¡œ í–ˆì–´.", question: "ê¸°ë¡ì´ ì •í™•íˆ 15ì´ˆì¸ ì¹œêµ¬ëŠ” ëŒ€í‘œ ì„ ìˆ˜ê°€ ë  ìˆ˜ ìˆì„ê¹Œ?", options: [{ text: "ì•„ë‹ˆ, 'ë¯¸ë§Œ'ì€ 15ì´ˆë¥¼ í¬í•¨í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— ë  ìˆ˜ ì—†ì–´.", isCorrect: true }, { text: "ì‘, 15ì´ˆëŠ” ë¹ ë¥¸ ê¸°ë¡ì´ë‹ˆê¹Œ ë‹¹ì—°íˆ ë  ìˆ˜ ìˆì–´.", isCorrect: false }], hint: "'ë¯¸ë§Œ'ì€ ê¸°ì¤€ì´ ë˜ëŠ” ìˆ˜ë¥¼ í¬í•¨í•˜ì§€ ì•Šì•„." }
                ],
                'ìƒ-í•˜': [
                    { difficulty: 'ìƒ-í•˜', story: "ê°€ê²Œì— '5000ì› ì´í•˜ì¸ ë¬¼ê±´'ë§Œ 10% í• ì¸ì„ í•´ì¤€ëŒ€. 5000ì›ì§œë¦¬ ì¥ë‚œê°ì€ í• ì¸ì´ ë ê¹Œ?", question: "5000ì› ì´í•˜'ëŠ” 5000ê³¼ (___)ê±°ë‚˜ (___) ìˆ˜ë¥¼ ì˜ë¯¸í•˜ë¯€ë¡œ, 5000ì›ì§œë¦¬ ì¥ë‚œê°ì€ í• ì¸ì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê´„í˜¸ì— ë“¤ì–´ê°ˆ ë§ì„ ìˆœì„œëŒ€ë¡œ ì ì–´ë³´ì„¸ìš”.", answerKeywords: ["ê°™", "ì‘ì€"], hint: "'ì´í•˜'ëŠ” ê¸°ì¤€ì´ ë˜ëŠ” ìˆ˜ë¥¼ í¬í•¨í• ê¹Œ? ê·¸ë¦¬ê³  ê·¸ ìˆ˜ë³´ë‹¤ ì»¤ì•¼ í• ê¹Œ, ì‘ì•„ì•¼ í• ê¹Œ?" },
                    { difficulty: 'ìƒ-í•˜', story: "ë°˜ì˜¬ë¦¼í•˜ì—¬ ì‹­ì˜ ìë¦¬ê¹Œì§€ ë‚˜íƒ€ë‚¼ ë•Œ, 57ì€ 60ì´ ë˜ê³  54ëŠ” 50ì´ ë¼.", question: "ë°˜ì˜¬ë¦¼ì€ ì¼ì˜ ìë¦¬ ìˆ«ìê°€ (___) ì´ìƒì´ë©´ ì˜¬ë¦¬ê³ , (___) ë¯¸ë§Œì´ë©´ ë²„ë¦¬ëŠ” ë°©ë²•ì´ì•¼. ê´„í˜¸ ì•ˆì˜ ìˆ«ìë¥¼ ì ì–´ë´.", answerKeywords: ["5", "5"], hint: "ê¸°ì¤€ì´ ë˜ëŠ” ìˆ«ìëŠ” ë¬´ì—‡ì¼ê¹Œ?" }
                ],
                'ìƒ-ì¤‘': [
                    { difficulty: 'ìƒ-ì¤‘', story: "ìš°ë¦¬ ë°˜ ì¹œêµ¬ë“¤ì˜ ìˆ˜í•™ ì ìˆ˜ë¥¼ ë³´ë‹ˆ, 80ì  ì´ìƒ 90ì  ë¯¸ë§Œì¸ ì¹œêµ¬ë“¤ì´ ê°€ì¥ ë§ì•˜ì–´.", question: "ì´ ë²”ìœ„ë¥¼ '80ì ë¶€í„°'ì™€ '90ì ê¹Œì§€'ë¼ëŠ” í‘œí˜„ì„ ì‚¬ìš©í•´ì„œ ì„¤ëª…í•´ë´. (ë‹¨, 90ì ì€ í¬í•¨ë˜ì§€ ì•Šì•„ì•¼ í•´)", answerKeywords: ["80ì ë¶€í„°", "90ì ê¹Œì§€ëŠ” ì•„ë‹˜", "90ì ì€ ì•ˆë¨", "90ì ë³´ë‹¤ ë‚®"], hint: "'ì´ìƒ'ì€ 'ê·¸ ì ìˆ˜ë¶€í„° ì‹œì‘í•´ì„œ'ë¡œ, 'ë¯¸ë§Œ'ì€ 'ê·¸ ì ìˆ˜ê¹Œì§€ëŠ” ì•„ë‹ˆê³  ë°”ë¡œ ì „ê¹Œì§€'ë¡œ ë°”ê¿” ë§í•  ìˆ˜ ìˆì–´." },
                    { difficulty: 'ìƒ-ì¤‘', story: "ë¬¼ê±´ê°’ì´ 880ì› ë‚˜ì™”ì–´. 100ì›ì§œë¦¬ ë™ì „ìœ¼ë¡œë§Œ ê°’ì„ ë‚´ë ¤ë©´ 900ì›ì„ ë‚´ì•¼ í•´.", question: "ì´ ìƒí™©ì„ 'ì˜¬ë¦¼'ì´ë¼ëŠ” ë‹¨ì–´ë¥¼ ì‚¬ìš©í•´ì„œ ì„¤ëª…í•´ë´.", answerKeywords: ["880", "ì˜¬ë¦¼", "ë°±ì˜ ìë¦¬", "900"], hint: "ì–´ëŠ ìë¦¬ê¹Œì§€ ë‚˜íƒ€ë‚´ê¸° ìœ„í•´ ì˜¬ë¦¼ì„ í•œ ê±¸ê¹Œ?" }
                ],
                'ìƒ-ìƒ': [
                    { difficulty: 'ìƒ-ìƒ', story: "ì¡°ê±´: ì˜¬ë¦¼, 1234ì›, ì‹­ì˜ ìë¦¬ê¹Œì§€", question: "ìœ„ ì¡°ê±´ë“¤ì„ ì‚¬ìš©í•´ì„œ 'ì˜¬ë¦¼' ê°œë…ì´ í•„ìš”í•œ ìƒí™©ê³¼ ê·¸ ê²°ê³¼ë¥¼ ì´ì•¼ê¸°ë¡œ ë§Œë“¤ì–´ë´.", answerKeywords: ["1234", "ì˜¬ë¦¼", "ì‹­", "1240"], hint: "ë¬¼ê±´ì„ ì‚´ ë•Œ 10ì›ì§œë¦¬ ë™ì „ë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ìƒí™©ì„ ìƒìƒí•´ë´." },
                    { difficulty: 'ìƒ-ìƒ', story: "ì¡°ê±´: ë²„ë¦¼, 485ê°œ ì‚¬íƒ•, 10ê°œì”©", question: "ìœ„ ì¡°ê±´ë“¤ì„ ì‚¬ìš©í•´ì„œ 'ë²„ë¦¼' ê°œë…ì´ í•„ìš”í•œ í¬ì¥ ë¬¸ì œë¥¼ ë§Œë“¤ì–´ë´.", answerKeywords: ["485", "ë²„ë¦¼", "10ê°œ", "48ë¬¶ìŒ"], hint: "ì‚¬íƒ•ì„ 10ê°œì”© ë¬¶ì–´ì„œ íŒ” ë•Œ, ëª‡ ë¬¶ìŒê¹Œì§€ íŒ” ìˆ˜ ìˆì„ê¹Œ?" }
                ]
            },
            'chapter2': {
                'í•˜': [
                    { difficulty: 'í•˜', story: "ì»¤ë‹¤ë€ ì´ˆì½œë¦¿ í•œ íŒì„ ë˜‘ê°™ì´ 5ì¡°ê°ìœ¼ë¡œ ë‚˜ëˆ´ì–´...", question: "ë¶„ìˆ˜ì™€ ìì—°ìˆ˜ì˜ ê³±ì…ˆì€ ì–´ë–»ê²Œ ê³„ì‚°í•´ì•¼ í• ê¹Œ?", options: [{ text: "ë¶„ëª¨ëŠ” ê·¸ëŒ€ë¡œ ë‘ê³ , ë¶„ìì— ìì—°ìˆ˜ë¥¼ ê³±í•˜ë©´ ë¼.", isCorrect: true }, { text: "ë¶„ìëŠ” ê·¸ëŒ€ë¡œ ë‘ê³ , ë¶„ëª¨ì— ìì—°ìˆ˜ë¥¼ ê³±í•´ì•¼ í•´.", isCorrect: false }], hint: "ì¡°ê°ì˜ í¬ê¸°(ë¶„ëª¨)ëŠ” ë³€í•˜ì§€ ì•Šê³ , ì¡°ê°ì˜ ê°œìˆ˜(ë¶„ì)ë§Œ ëŠ˜ì–´ë‚¬ì–´." },
                    { difficulty: 'í•˜', story: "ì¼€ì´í¬ í•œ íŒì„ 4ì¡°ê°ìœ¼ë¡œ ë‚˜ëˆˆ ê²ƒ ì¤‘ 1ì¡°ê°(1/4)ì´ 2ê°œ ìˆë‹¤ë©´...", question: " (1/4) Ã— 2 ë¥¼ ê³„ì‚°í•˜ëŠ” ì˜¬ë°”ë¥¸ ë°©ë²•ì„ ê³¨ë¼ë´.", options: [{ text: "ë¶„ì 1ì— 2ë¥¼ ê³±í•´ì„œ 2/4ê°€ ë¼.", isCorrect: true }, { text: "ë¶„ëª¨ 4ì— 2ë¥¼ ê³±í•´ì„œ 1/8ì´ ë¼.", isCorrect: false }], hint: "ì¡°ê°ì˜ ê°œìˆ˜ê°€ 2ë°°ê°€ ë˜ëŠ” ê±°ì•¼." }
                ],
                'ì¤‘': [
                    { difficulty: 'ì¤‘', story: "ì–´ì œ í”¼ì í•œ íŒì˜ 1/2ì„ ë¨¹ê³  ë‚¨ì€ ì–‘ì´ ìˆì—ˆì–´. ì˜¤ëŠ˜ ê·¸ ë‚¨ì€ í”¼ìì˜ 1/2ì„ ë˜ ë¨¹ì—ˆì§€.", question: "ë‚´ê°€ ì˜¤ëŠ˜ ë¨¹ì€ í”¼ìì˜ ì–‘ì€ ì „ì²´ í”¼ìì˜ ì–¼ë§ˆë§Œí¼ì¼ê¹Œ?", options: [{ text: "ë‚¨ì€ ì–‘(1/2)ì˜ ë¶€ë¶„ì´ë¯€ë¡œ, (1/2) Ã— (1/2) = 1/4 ì´ì•¼.", isCorrect: true }, { text: "ë‘ ì¡°ê°ì„ ë¨¹ì—ˆìœ¼ë‹ˆ (1/2) + (1/2) = 1 ì´ì•¼.", isCorrect: false }], hint: "'~ì˜ ~ë§Œí¼' ì´ë¼ëŠ” í‘œí˜„ì€ ê³±ì…ˆìœ¼ë¡œ ê³„ì‚°í•  ìˆ˜ ìˆì–´." },
                     { difficulty: 'ì¤‘', story: "ë°€ê°€ë£¨ 3/4 ì»µì´ ìˆì—ˆëŠ”ë°, ì¿ í‚¤ë¥¼ ë§Œë“¤ë ¤ê³  ê·¸ ì–‘ì˜ 1/3ì„ ì‚¬ìš©í–ˆì–´.", question: "ì‚¬ìš©í•œ ë°€ê°€ë£¨ì˜ ì–‘ì„ êµ¬í•˜ëŠ” ì˜¬ë°”ë¥¸ ì‹ì€ ë¬´ì—‡ì¼ê¹Œ?", options: [{ text: "(3/4) Ã— (1/3)", isCorrect: true }, { text: "(3/4) - (1/3)", isCorrect: false }], hint: "ì „ì²´ ì–‘ì˜ ì¼ë¶€ë¶„ì„ êµ¬í•  ë•ŒëŠ” ê³±ì…ˆì„ ì‚¬ìš©í•´." }
                ],
                'ìƒ-í•˜': [
                    { difficulty: 'ìƒ-í•˜', story: "ì§„ë¶„ìˆ˜ì˜ ê³±ì…ˆ (2/3) Ã— (4/5)ë¥¼ ê³„ì‚°í•˜ë©´ ì–´ë–»ê²Œ ë ê¹Œ?", question: "ê³„ì‚° ê²°ê³¼ëŠ” ë¶„ìˆ˜ë¡œ ì–´ë–»ê²Œ ë ê¹Œìš”? ëª©ì†Œë¦¬ë¡œ ë‹µí•˜ê±°ë‚˜ ì§ì ‘ ì…ë ¥í•´ë³´ì„¸ìš”.", answerKeywords: ["8/15"], hint: "ë¶„ìëŠ” ë¶„ìë¼ë¦¬, ë¶„ëª¨ëŠ” ë¶„ëª¨ë¼ë¦¬ ê³±í•˜ë©´ ë¼." },
                    { difficulty: 'ìƒ-í•˜', story: "ëŒ€ë¶„ìˆ˜ì˜ ê³±ì…ˆ 1ê³¼ 1/2 Ã— 2ì™€ 1/3 ì„ í•˜ë ¤ë©´, ë¨¼ì € ëŒ€ë¶„ìˆ˜ë¥¼ ê°€ë¶„ìˆ˜ë¡œ ë°”ê¿”ì•¼ í•´.", question: "1ê³¼ 1/2ì€ (___)/2 ì´ê³ , 2ì™€ 1/3ì€ (___)/3 ì´ì•¼. ê´„í˜¸ ì•ˆì˜ ìˆ«ìë¥¼ ìˆœì„œëŒ€ë¡œ ì ì–´ë´.", answerKeywords: ["3", "7"], hint: "(ìì—°ìˆ˜ Ã— ë¶„ëª¨) + ë¶„ì ë¥¼ ê³„ì‚°í•´ì„œ ê°€ë¶„ìˆ˜ì˜ ë¶„ìë¥¼ êµ¬í•˜ì§€." }
                ],
                'ìƒ-ì¤‘': [
                     { difficulty: 'ìƒ-ì¤‘', story: "ë‚˜ëŠ” ì¼€ì´í¬ í•œ íŒì˜ 1/4ì„ ê°€ì§€ê³  ìˆì—ˆëŠ”ë°, ê·¸ì¤‘ì—ì„œ ì ˆë°˜ì„ ì¹œêµ¬ì—ê²Œ ì£¼ì—ˆì–´.", question: "ë‚´ê°€ ì¹œêµ¬ì—ê²Œ ì¤€ ì¼€ì´í¬ì˜ ì–‘ì„ 'ê³±'ì´ë¼ëŠ” ë‹¨ì–´ ëŒ€ì‹  'ë°°'ë¼ëŠ” ë‹¨ì–´ë¥¼ ì‚¬ìš©í•´ì„œ ì„¤ëª…í•´ë´.", answerKeywords: ["1/4", "1/2", "ë°°", "1/8"], hint: "ì ˆë°˜ì€ 1/2ë°°ì™€ ê°™ì€ ë§ì´ì•¼. '~ì˜ ~ë°°'ëŠ” ê³±ì…ˆìœ¼ë¡œ ë‚˜íƒ€ë‚¼ ìˆ˜ ìˆì–´." },
                     { difficulty: 'ìƒ-ì¤‘', story: "ìš´ë™ì¥ í•œ ë°”í€´ëŠ” 3/5 km ì•¼. ë‚´ê°€ 2ë°”í€´ë¥¼ ëŒì•˜ë‹¤ë©´ ì´ 6/5 kmë¥¼ ë‹¬ë¦° ì…ˆì´ì§€.", question: "ì´ ìƒí™©ì„ 'ë¶„ìˆ˜ì™€ ìì—°ìˆ˜ì˜ ê³±ì…ˆ' ê°œë…ì„ ì‚¬ìš©í•´ì„œ ì„¤ëª…í•´ë´.", answerKeywords: ["3/5", "2", "ê³±í•˜", "6/5"], hint: "ê°™ì€ ê±°ë¦¬ë¥¼ ì—¬ëŸ¬ ë²ˆ ë°˜ë³µí•´ì„œ ê°”ì„ ë•Œ, ì „ì²´ ê±°ë¦¬ë¥¼ ì–´ë–»ê²Œ êµ¬í• ê¹Œ?" }
                ],
                'ìƒ-ìƒ': [
                    { difficulty: 'ìƒ-ìƒ', story: "ì¡°ê±´: ê³±ì…ˆ, 2 Ã— 4, ê°€ì¡± ì‚¬íƒ•", question: "ìœ„ ì¡°ê±´ë“¤ì„ ì‚¬ìš©í•´ì„œ 'ìì—°ìˆ˜ì˜ ê³±ì…ˆ'ì˜ ì˜ë¯¸ê°€ ì˜ ë“œëŸ¬ë‚˜ëŠ” ì´ì•¼ê¸° ë¬¸ì œë¥¼ ë§Œë“¤ì–´ë´.", answerKeywords: ["ê°€ì¡±", "4ëª…", "2ê°œ", "8ê°œ", "ëª¨ë‘"], hint: "'ë¬¶ì–´ ì„¸ê¸°' ê°œë…ì„ ë„£ì–´ë´." },
                    { difficulty: 'ìƒ-ìƒ', story: "ì¡°ê±´: ë¶„ìˆ˜ì˜ ê³±ì…ˆ, 1/2, 1/3, í”¼ì", question: "ìœ„ ì¡°ê±´ë“¤ì„ ì‚¬ìš©í•´ì„œ 'ë¶„ìˆ˜ Ã— ë¶„ìˆ˜' ê°œë…ì´ í•„ìš”í•œ ì´ì•¼ê¸° ë¬¸ì œë¥¼ ë§Œë“¤ì–´ë´.", answerKeywords: ["í”¼ì", "ë°˜", "1/2", "1/3", "1/6"], hint: "í”¼ìê°€ ë°˜ ì¡°ê° ë‚¨ì•˜ëŠ”ë°, ê·¸ ë‚¨ì€ ê²ƒì˜ 1/3ì„ ë¨¹ëŠ”ë‹¤ë©´...?" }
                ]
            },
            'chapter3': {
                'í•˜': [
                    { difficulty: 'í•˜', story: "ì¢…ì´ë¥¼ ë°˜ìœ¼ë¡œ ì ‘ì–´ì„œ í•˜íŠ¸ ëª¨ì–‘ì„ ì˜¤ë ¸ë”ë‹ˆ, ì–‘ìª½ ëª¨ì–‘ê³¼ í¬ê¸°ê°€ ë˜‘ê°™ì€ í•˜íŠ¸ê°€ ë‚˜ì™”ì–´! ì´ë ‡ê²Œ ëª¨ì–‘ê³¼ í¬ê¸°ê°€ ë˜‘ê°™ì•„ì„œ ì™„ì „íˆ í¬ê°¤ ìˆ˜ ìˆëŠ” ë‘ ë„í˜•ì„ ë­ë¼ê³  ë¶€ë¥¼ê¹Œ?", question: "ëª¨ì–‘ê³¼ í¬ê¸°ê°€ ê°™ì•„ ì™„ì „íˆ ê²¹ì¹˜ëŠ” ë‘ ë„í˜•ì˜ ê´€ê³„ë¥¼ ë¬´ì—‡ì´ë¼ê³  í• ê¹Œ?", options: [{ text: "í•©ë™", isCorrect: true }, { text: "ëŒ€ì¹­", isCorrect: false }], hint: "ì„œë¡œ ì™„ì „íˆ ë˜‘ê°™ì€ ìŒë‘¥ì´ ë„í˜•ì„ ìƒê°í•˜ë©´ ì‰¬ì›Œ." },
                    { difficulty: 'í•˜', story: "ë‚˜ë¹„ì˜ ë‚ ê°œë¥¼ ë³´ë©´ ê°€ìš´ë° ëª¸ì„ ê¸°ì¤€ìœ¼ë¡œ ì–‘ìª½ ë‚ ê°œì˜ ë¬´ëŠ¬ê°€ ë˜‘ê°™ì•„. ë§ˆì¹˜ ë°ì¹¼ì½”ë§ˆë‹ˆì²˜ëŸ¼ ë§ì´ì•¼. ì´ë ‡ê²Œ í•œ ì§ì„ ì„ ë”°ë¼ ì ‘ì—ˆì„ ë•Œ ì™„ì „íˆ ê²¹ì¹˜ëŠ” ë„í˜•ì„ ì„ ëŒ€ì¹­ë„í˜•ì´ë¼ê³  í•´.", question: "ì„ ëŒ€ì¹­ë„í˜•ì˜ ì¤‘ì‹¬ì´ ë˜ëŠ” ê·¸ ì„ ì„ ë¬´ì—‡ì´ë¼ê³  ë¶€ë¥¼ê¹Œ?", options: [{ text: "ëŒ€ì¹­ì¶•", isCorrect: true }, { text: "ëŒ€ì¹­ì˜ ì¤‘ì‹¬", isCorrect: false }], hint: "'ì„ 'ëŒ€ì¹­ë„í˜•ì´ë‹ˆê¹Œ, ì¤‘ì‹¬ì´ ë˜ëŠ” ê²ƒë„ 'ì„ 'ì´ ì•„ë‹ê¹Œ?" }
                ],
                'ì¤‘': [
                    { difficulty: 'ì¤‘', story: "ì„œë¡œ í•©ë™ì¸ ì‚¼ê°í˜• ë‘ ê°œê°€ ìˆì–´. í•œ ì‚¼ê°í˜•ì˜ ë³€ì˜ ê¸¸ì´ê°€ ê°ê° 5cm, 6cm, 7cmë¼ë©´, ë‹¤ë¥¸ ì‚¼ê°í˜•ì—ì„œ ê°€ì¥ ê¸´ ë³€ì˜ ê¸¸ì´ëŠ” ëª‡ cmì¼ê¹Œ?", question: "í•©ë™ì¸ ë„í˜•ì—ì„œ, ëŒ€ì‘í•˜ëŠ” ë³€ì˜ ê¸¸ì´ëŠ” ì–´ë–¨ê¹Œ?", options: [{ text: "ì„œë¡œ ê¸¸ì´ê°€ ê°™ìœ¼ë¯€ë¡œ 7cmì•¼.", isCorrect: true }, { text: "ëª¨ì–‘ë§Œ ê°™ê³  ê¸¸ì´ëŠ” ë‹¤ë¥¼ ìˆ˜ ìˆì–´.", isCorrect: false }], hint: "í•©ë™ì€ ëª¨ì–‘ê³¼ 'í¬ê¸°'ê°€ ëª¨ë‘ ê°™ì€ ê´€ê³„ì•¼." },
                    { difficulty: 'ì¤‘', story: "í‰í–‰ì‚¬ë³€í˜•ì€ ì ëŒ€ì¹­ë„í˜•ì´ì•¼. ì–´ë–¤ ì ì„ ì¤‘ì‹¬ìœ¼ë¡œ 180ë„ ëŒë¦¬ë©´ ì›ë˜ ëª¨ìŠµê³¼ ë˜‘ê°™ì´ ê²¹ì³ì ¸.", question: "í‰í–‰ì‚¬ë³€í˜•ì„ 180ë„ ëŒë ¸ì„ ë•Œ, ì›ë˜ì˜ ìœ„ì¹˜ì™€ ê²¹ì³ì§€ëŠ” ê°ì˜ í¬ê¸°ëŠ” ì–´ë–¨ê¹Œ?", options: [{ text: "ëŒ€ì‘í•˜ëŠ” ê°ì´ë¯€ë¡œ í¬ê¸°ê°€ ê°™ì•„.", isCorrect: true }, { text: "ìœ„ì¹˜ê°€ ë°”ë€Œì—ˆìœ¼ë‹ˆ í¬ê¸°ë„ ë‹¬ë¼ì ¸.", isCorrect: false }], hint: "ì ëŒ€ì¹­ë„í˜•ì˜ ì„±ì§ˆì„ ìƒê°í•´ë´. ëŒë ¤ë„ ëª¨ì–‘ê³¼ í¬ê¸°ëŠ” ë³€í•˜ì§€ ì•Šì•„." }
                ],
                'ìƒ-í•˜': [
                    { difficulty: 'ìƒ-í•˜', story: "ì„ ëŒ€ì¹­ë„í˜•ì—ì„œ ëŒ€ì¹­ì¶•ì„ ë”°ë¼ ì ‘ìœ¼ë©´ ëŒ€ì‘ë³€ë¼ë¦¬ ì™„ì „íˆ ê²¹ì³ì ¸.", question: "ë³€ ã„±ã„´ì˜ ëŒ€ì‘ë³€ì´ ë³€ ã„·ã„¹ì¼ ë•Œ, ë‘ ë³€ì˜ ê¸¸ì´ëŠ” ì„œë¡œ (___).", answerKeywords: ["ê°™ë‹¤"], hint: "ëŒ€ì¹­ì¶•ì„ ê¸°ì¤€ìœ¼ë¡œ ì ‘ì—ˆì„ ë•Œ ì™„ì „íˆ í¬ê°œì§€ëŠ” ë³€ì„ ì°¾ì•„ë´." },
                    { difficulty: 'ìƒ-í•˜', story: "ì ëŒ€ì¹­ë„í˜•ì˜ ëŒ€ì¹­ì˜ ì¤‘ì‹¬ì€ ëŒ€ì‘ì ë¼ë¦¬ ì´ì€ ì„ ë¶„ì„ ë‘˜ë¡œ ë˜‘ê°™ì´ ë‚˜ëˆ„ëŠ” ì„±ì§ˆì´ ìˆì–´.", question: "ëŒ€ì‘ì  ã„±ê³¼ ì  ã„·ì„ ì´ì€ ì„ ë¶„ì˜ ê¸¸ì´ê°€ 10cmë¼ë©´, ëŒ€ì¹­ì˜ ì¤‘ì‹¬ë¶€í„° ì  ã„±ê¹Œì§€ì˜ ê±°ë¦¬ëŠ” (___)cm ì…ë‹ˆë‹¤.", answerKeywords: ["5"], hint: "ì „ì²´ ê¸¸ì´ì˜ ì ˆë°˜ì´ ë  ê±°ì•¼." }
                ],
                'ìƒ-ì¤‘': [
                    { difficulty: 'ìƒ-ì¤‘', story: "í•©ë™ì¸ ë‘ ì‚¼ê°í˜•ì—ì„œ ê° ã„±ã„´ã„·ì˜ ëŒ€ì‘ê°ì€ ê° ã„¹ã…ã…‚ì´ì•¼.", question: "'ëŒ€ì‘ê°'ì´ë¼ëŠ” ë§ì„ ì“°ì§€ ì•Šê³ , ë‘ ê°ì˜ ê´€ê³„ë¥¼ 'í¬ê° ë‹¤', 'ê²¹ì¹œë‹¤'ëŠ” í‘œí˜„ì„ ì‚¬ìš©í•´ì„œ ì„¤ëª…í•´ë´.", answerKeywords: ["í¬ê°œ", "ê²¹ì¹˜"], hint: "ë‘ ë„í˜•ì„ í•©ì³ë³¼ ë•Œ, ì–´ë–¤ ìœ„ì¹˜ì— ìˆëŠ” ê°ì¼ê¹Œ?" },
                    { difficulty: 'ìƒ-ì¤‘', story: "ì •ì‚¬ê°í˜•ì€ ì„ ëŒ€ì¹­ë„í˜•ì´ë©´ì„œ ì ëŒ€ì¹­ë„í˜•ì´ê¸°ë„ í•´.", question: "ì •ì‚¬ê°í˜•ì´ ì™œ 'ì ëŒ€ì¹­ë„í˜•'ì¸ì§€, '180ë„'ì™€ 'ì¤‘ì‹¬'ì´ë¼ëŠ” ë‹¨ì–´ë¥¼ ì‚¬ìš©í•´ì„œ ì„¤ëª…í•´ë´.", answerKeywords: ["ì¤‘ì‹¬", "180ë„", "ëŒë¦¬", "ê²¹ì¹˜"], hint: "ì •ì‚¬ê°í˜•ì˜ ë‘ ëŒ€ê°ì„ ì´ ë§Œë‚˜ëŠ” ì ì„ ì¤‘ì‹¬ìœ¼ë¡œ ëŒë¦¬ë©´ ì–´ë–»ê²Œ ë ê¹Œ?" }
                ],
                'ìƒ-ìƒ': [
                    { difficulty: 'ìƒ-ìƒ', story: "ì¡°ê±´: ì„ ëŒ€ì¹­, ë³´ë¬¼ì§€ë„, ì ‘ê¸°", question: "ìœ„ ì¡°ê±´ë“¤ì„ ì‚¬ìš©í•´ì„œ 'ì„ ëŒ€ì¹­'ì˜ ê°œë…ì´ ì˜ ë“œëŸ¬ë‚˜ëŠ” ë³´ë¬¼ì°¾ê¸° ì´ì•¼ê¸°ë¥¼ ë§Œë“¤ì–´ë´.", answerKeywords: ["ì§€ë„", "ì„ ", "ì¶•", "ì ‘ì–´", "ë³´ë¬¼"], hint: "ì§€ë„ì˜ ì–´ë–¤ ì„ ì„ ë”°ë¼ ì ‘ì—ˆë”ë‹ˆ, ë‘ ì§€ì ì´ ê²¹ì³ì§€ëŠ” ê³³ì— ë³´ë¬¼ì´ ìˆ¨ê²¨ì ¸ ìˆëŠ” ì´ì•¼ê¸°ë¥¼ ìƒìƒí•´ë´." },
                    { difficulty: 'ìƒ-ìƒ', story: "ì¡°ê±´: í•©ë™, ì¿ í‚¤, ë‘ ê°œ", question: "ìœ„ ì¡°ê±´ë“¤ì„ ì‚¬ìš©í•´ì„œ 'í•©ë™'ì˜ ê°œë…ì´ í•„ìš”í•œ ì¿ í‚¤ ë§Œë“¤ê¸° ì´ì•¼ê¸°ë¥¼ ë§Œë“¤ì–´ë´.", answerKeywords: ["ì¿ í‚¤", "ëª¨ì–‘", "í¬ê¸°", "ë˜‘ê°™", "í•©ë™"], hint: "ë˜‘ê°™ì€ ëª¨ì–‘ì˜ ì¿ í‚¤ í‹€ë¡œ ì°ì–´ë‚¸ ë‘ ì¿ í‚¤ëŠ” ì„œë¡œ ì–´ë–¤ ê´€ê³„ì¼ê¹Œ?" }
                ]
            },
            'chapter4': {}, 'chapter5': {}, 'chapter6': {}
        };
        
        // --- Web Speech API Setup ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'ko-KR';
            recognition.interimResults = false;
        }

        const difficultyOrder = ['í•˜', 'ì¤‘', 'ìƒ-í•˜', 'ìƒ-ì¤‘', 'ìƒ-ìƒ'];
        let currentDifficultyIndex = 0;
        let attemptsLeft = 8;
        let score = 0; 
        let chapterQuestions = {};
        let questionIndices = {};

        const startScreenEl = document.getElementById('start-screen');
        const gameScreenEl = document.getElementById('game-screen');
        const chapterSelectionEl = document.getElementById('chapter-selection');
        const gameTitleEl = gameScreenEl.querySelector('.game-title');
        const attemptsTrackerEl = document.getElementById('attempts-tracker');
        const gameAreaEl = document.getElementById('game-area');
        const progressImage = document.getElementById('progress-image');

        function startGame(chapterKey) {
            startScreenEl.style.display = 'none';
            gameScreenEl.style.display = 'block';
            gameTitleEl.textContent = chapterInfo[chapterKey].fullName;

            chapterQuestions = JSON.parse(JSON.stringify(allQuizData[chapterKey]));
            questionIndices = {};
            for (const difficulty in chapterQuestions) {
                if (chapterQuestions[difficulty]) {
                    shuffleArray(chapterQuestions[difficulty]);
                    questionIndices[difficulty] = 0;
                }
            }
            
            currentDifficultyIndex = 0;
            attemptsLeft = 8;
            score = 0;
            
            attemptsTrackerEl.textContent = `ë‚¨ì€ ê¸°íšŒ: ${attemptsLeft}`;
            resetGameArea();
            updateProgress();
            loadQuestion();
        }

        function resetGameArea() {
             gameAreaEl.innerHTML = `
                <div class="story-container" id="story"></div>
                <div class="question-container" id="question"></div>
                <div class="options-container" id="options"></div>
                <div id="text-answer-area" style="display: none;">
                    <textarea id="text-answer-input" placeholder="ì—¬ê¸°ì— ë‹µì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                    <div class="submit-area">
                        <button type="button" id="submit-text-answer">ì œì¶œí•˜ê¸°</button>
                        ${SpeechRecognition ? '<button type="button" id="mic-btn">ğŸ¤ ë§ë¡œ ë‹µí•˜ê¸°</button>' : ''}
                    </div>
                </div>
                <div class="hint-container" id="hint"></div>
            `;
        }

        function shuffleArray(array) {
            if (!array || array.length === 0) return;
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
        
        function loadQuestion() {
            if (currentDifficultyIndex >= difficultyOrder.length) {
                endGame(true); return;
            }
            if (attemptsLeft <= 0) {
                endGame(false); return;
            }

            const currentDifficulty = difficultyOrder[currentDifficultyIndex];
            const questionsForLevel = chapterQuestions[currentDifficulty];
            
            if (!questionsForLevel || questionsForLevel.length === 0) {
                endGame(false, true); return;
            }
            
            const qIndex = questionIndices[currentDifficulty];
            const currentQuiz = questionsForLevel[qIndex];
            
            if (!currentQuiz) {
                endGame(false, true); return;
            }
            
            gameAreaEl.dataset.currentQuiz = JSON.stringify(currentQuiz);

            document.getElementById('story').textContent = currentQuiz.story;
            document.getElementById('question').textContent = currentQuiz.question;
            
            const optionsEl = document.getElementById('options');
            const textAnswerAreaEl = document.getElementById('text-answer-area');
            const textAnswerInputEl = document.getElementById('text-answer-input');

            if (currentQuiz.difficulty.startsWith('ìƒ')) {
                optionsEl.style.display = 'none';
                textAnswerAreaEl.style.display = 'block';
                textAnswerInputEl.value = '';
                if (currentQuiz.difficulty === 'ìƒ-í•˜') textAnswerInputEl.placeholder = "ë¹ˆì¹¸/ë¶„ìˆ˜ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ë§í•´ë³´ì„¸ìš”...";
                else if (currentQuiz.difficulty === 'ìƒ-ì¤‘') textAnswerInputEl.placeholder = "ìƒí™©ì„ ë‹¤ë¥¸ í‘œí˜„ìœ¼ë¡œ ì„¤ëª…í•´ë³´ì„¸ìš”...";
                else textAnswerInputEl.placeholder = "ì£¼ì–´ì§„ ì¡°ê±´ìœ¼ë¡œ ì´ì•¼ê¸° ë¬¸ì œë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”...";
            } else {
                optionsEl.style.display = 'flex';
                textAnswerAreaEl.style.display = 'none';
                optionsEl.innerHTML = '';
                currentQuiz.options.forEach(option => {
                    const button = document.createElement('button');
                    button.type = "button";
                    button.textContent = option.text;
                    button.classList.add('option-btn');
                    button.dataset.correct = option.isCorrect;
                    optionsEl.appendChild(button);
                });
            }
            document.getElementById('hint').style.display = 'none';
        }

        function handleAnswer(isCorrect) {
            attemptsLeft--;
            attemptsTrackerEl.textContent = `ë‚¨ì€ ê¸°íšŒ: ${attemptsLeft}`;
            const hintEl = document.getElementById('hint');
            const currentQuiz = JSON.parse(gameAreaEl.dataset.currentQuiz);
            
            if (isCorrect) {
                score++;
                currentDifficultyIndex++;
                updateProgress();
                loadQuestion();
            } else {
                hintEl.textContent = `ğŸ’¡ ${currentQuiz.hint}`;
                hintEl.style.display = 'block';
                
                const currentDifficulty = difficultyOrder[currentDifficultyIndex];
                questionIndices[currentDifficulty]++;
                if (questionIndices[currentDifficulty] >= chapterQuestions[currentDifficulty].length) {
                    questionIndices[currentDifficulty] = 0;
                }

                setTimeout(() => {
                    loadQuestion();
                }, 1500);
            }
        }

        function handleTextAnswer() {
            const userInput = document.getElementById('text-answer-input').value;
            const currentQuiz = JSON.parse(gameAreaEl.dataset.currentQuiz);
            const keywords = currentQuiz.answerKeywords;
            
            const isCorrect = keywords.every(keyword => userInput.replace(/\s/g, '').includes(keyword));
            handleAnswer(isCorrect);
        }

        function updateProgress() {
            const imageUrls = {
                seed: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Cellipse cx="50" cy="75" rx="20" ry="15" fill="%238B4513"/%3E%3C/svg%3E',
                sprout: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Cpath d="M50,70 Q60,50 70,40" stroke="%23228B22" stroke-width="5" fill="none"/%3E%3Cellipse cx="50" cy="75" rx="20" ry="15" fill="%238B4513"/%3E%3C/svg%3E',
                plant: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Cpath d="M50,90 V30 M30,50 Q50,45 50,30 M70,50 Q50,45 50,30" stroke="%23228B22" stroke-width="6" fill="none"/%3E%3C/svg%3E',
                flower: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Cpath d="M50,90 V40" stroke="%23228B22" stroke-width="6" fill="none"/%3E%3Ccircle cx="50" cy="30" r="20" fill="%23FFD700"/%3E%3Ccircle cx="50" cy="30" r="10" fill="%23DAA520"/%3E%3C/svg%3E'
            };
            const growthStages = [ imageUrls.seed, imageUrls.sprout, imageUrls.sprout, imageUrls.plant, imageUrls.plant, imageUrls.flower ];
            progressImage.src = growthStages[score] || imageUrls.seed;
            
            if(score > 0){
                progressImage.style.transform = 'scale(1.1)';
                setTimeout(() => { progressImage.style.transform = 'scale(1)'; }, 300);
            }
        }
        
        function endGame(isWin, noQuestions = false) {
            let message = '';
            if (noQuestions) {
                message = `ë¬¸ì œê°€ ëª¨ë‘ ì†Œì§„ë˜ì—ˆì–´ìš”!<br> ë‹¤ë¥¸ ë‹¨ì›ì— ë„ì „í•´ë³´ì„¸ìš”.`;
            } else if (isWin) {
                message = `ëª¨ë“  ë¬¸ì œë¥¼ í•´ê²°í–ˆì–´! <br> ì˜ˆìœ ìˆ˜í•™ ê½ƒì´ í™œì§ í”¼ì—ˆë„¤!`;
                progressImage.src = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Cpath d="M50,90 V40" stroke="%23228B22" stroke-width="6" fill="none"/%3E%3Ccircle cx="50" cy="30" r="20" fill="%23FFD700"/%3E%3Ccircle cx="50" cy="30" r="10" fill="%23DAA520"/%3E%3C/svg%3E';
                progressImage.style.transform = 'scale(1.2)';
            } else {
                message = `ì•„ì‰½ì§€ë§Œ ê¸°íšŒë¥¼ ëª¨ë‘ ì‚¬ìš©í–ˆì–´.<br>ë‹¤ì‹œ ë„ì „í•´ë³¼ê¹Œ?`;
                progressImage.src = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Cellipse cx="50" cy="75" rx="20" ry="15" fill="%238B4513"/%3E%3C/svg%3E';
            }
            gameAreaEl.innerHTML = `<div class="final-message">${message}</div>
            <button type="button" id="back-to-start">ë‹¨ì› ì„ íƒìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>`;
            
            document.getElementById('back-to-start').addEventListener('click', () => {
                gameScreenEl.style.display = 'none';
                startScreenEl.style.display = 'block';
                progressImage.style.transform = 'scale(1)';
            });
        }

        function parseFraction(text) {
            const numMap = { 'ì¼': '1', 'ì´': '2', 'ì‚¼': '3', 'ì‚¬': '4', 'ì˜¤': '5', 'ìœ¡': '6', 'ì¹ ': '7', 'íŒ”': '8', 'êµ¬': '9', 'ì‹­': '10' };
            let processedText = text.replace(/\s+/g, '');
            for(const key in numMap) {
                processedText = processedText.replace(new RegExp(key, "g"), numMap[key]);
            }
            
            if (processedText.includes('ë¶„ì˜')) {
                const parts = processedText.split('ë¶„ì˜');
                const denominator = parts[0];
                const numerator = parts[1];
                if (!isNaN(denominator) && !isNaN(numerator)) {
                    return `${numerator}/${denominator}`;
                }
            }
            return text;
        }

        function setupEventListeners() {
            gameScreenEl.addEventListener('click', (e) => {
                if (e.target.classList.contains('option-btn')) {
                    handleAnswer(e.target.dataset.correct === 'true');
                }
                if (e.target.id === 'submit-text-answer') {
                    handleTextAnswer();
                }
                if (e.target.id === 'mic-btn' && recognition) {
                    const micBtn = e.target;
                    micBtn.classList.add('listening');
                    micBtn.textContent = 'ë“£ëŠ” ì¤‘...';
                    recognition.start();
                }
            });

            if (recognition) {
                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    const textInput = document.getElementById('text-answer-input');
                    textInput.value = parseFraction(transcript);
                };
                recognition.onend = () => {
                    const micBtn = document.getElementById('mic-btn');
                    if(micBtn) {
                       micBtn.classList.remove('listening');
                       micBtn.textContent = 'ğŸ¤ ë§ë¡œ ë‹µí•˜ê¸°';
                    }
                };
                recognition.onerror = (event) => {
                    console.error("Speech recognition error", event.error);
                    const micBtn = document.getElementById('mic-btn');
                     if(micBtn) {
                       micBtn.classList.remove('listening');
                       micBtn.textContent = 'ğŸ¤ ë§ë¡œ ë‹µí•˜ê¸°';
                    }
                };
            }
        }

        Object.keys(chapterInfo).forEach(key => {
            const button = document.createElement('button');
            button.type = "button";
            button.classList.add('chapter-btn');
            button.textContent = chapterInfo[key].name;
            button.addEventListener('click', () => {
                const chapterData = allQuizData[key];
                if (!chapterData || Object.keys(chapterData).length === 0 || !Object.values(chapterData).some(arr => arr && arr.length > 0)) {
                    alert('ì•„ì§ ì¤€ë¹„ ì¤‘ì¸ ë‹¨ì›ì…ë‹ˆë‹¤.');
                    return;
                }
                startGame(key);
            });
            chapterSelectionEl.appendChild(button);
        });
        
        setupEventListeners();

    </script>
</body>
</html>

